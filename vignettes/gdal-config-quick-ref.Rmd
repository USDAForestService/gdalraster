---
title: "GDAL Config Quick Ref"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GDAL Config Quick Ref}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

last updated: 2023-11-19

Configuration options are essentially global variables the user can set. They are used to alter the default behavior of certain raster format drivers, and in some cases the GDAL core. A large number of configuration options are available. An overall discussion along with list of all available options and where they apply is in the GDAL documentation at https://gdal.org/user/configoptions.html.

This article is a quick reference to a small subset of configuration options that are commonly used, with links to topic-specific documentation provided by the GDAL project. Examples are given for configuring from R with `gdalraster::set_config_option()`. The values set in the examples are reasonable but not necessarily recommended as they are context dependent. 

```{r}
library(gdalraster)
# see `?set_config_option`
```

## General options

GDAL doc: https://gdal.org/user/configoptions.html#general-options

The `$read()` method of a `GDALRaster` object will perform automatic resampling if the specified output size (`out_xsize * out_ysize`) is different than the size of the source region being read (`xsize * ysize`). In that case, resampling can be configured to override the default `NEAR` to one of `BILINEAR`, `CUBIC`, `CUBICSPLINE`, `LANCZOS`, `AVERAGE` or `MODE`:

```{r}
set_config_option("GDAL_RASTERIO_RESAMPLING", "AVERAGE")
```

## Performance and caching

GDAL doc: https://gdal.org/user/configoptions.html#performance-and-caching

The `GDAL_NUM_THREADS` option sets the number of worker threads to be used by GDAL operations that support multithreading. This has effect in several different contexts including multi-threaded compression for GeoTiff and multithreaded computation during `warp()` (see below).

The size limit of the block cache is set upon first use (first I/O). Setting `GDAL_CACHEMAX` after that point will not resize the cache. It is a per-session setting. If `GDAL_CACHEMAX` has not been configured upon first use of the cache, then the default cache size (`5%`) will be in effect for the current session. See also [GDAL Block Cache](https://usdaforestservice.github.io/gdalraster/articles/gdal-block-cache.html).

```{r}
# set to a specific size in MB
set_config_option("GDAL_CACHEMAX", "1000")

# or percent of physical RAM
set_config_option("GDAL_CACHEMAX", "20%")
```

The default number of datasets that can be opened simultaneously by the `GDALProxyPool` mechanism (used by VRT for example) is `100`. This can be increased to get better random I/O performance with VRT mosaics made of numerous underlying raster files. Be careful: on Linux systems, the number of file handles that can be opened by a process is generally limited to `1024`. This is currently clamped between `2` and `1000`:

```{r}
set_config_option("GDAL_MAX_DATASET_POOL_SIZE", "200") # default is 100
```

## Networking options

GDAL doc: https://gdal.org/user/configoptions.html#networking-options

## PROJ

GDAL doc: https://gdal.org/user/configoptions.html#proj-options

The option `OSR_DEFAULT_AXIS_MAPPING_STRATEGY` can be set to either `TRADITIONAL_GIS_ORDER` or `AUTHORITY_COMPLIANT`. GDAL >= 3.5 defaults to `AUTHORITY_COMPLIANT`. Determines whether to honor the declared axis mapping of a CRS or override it with the traditional GIS ordering (x = longitude, y = latitude). **Note:** On loading gdalraster sets this option to `TRADITIONAL_GIS_ORDER`.

The default format for CRS export to Well Known Text is WKT 1 (as of GDAL 3.0). Can be overridden with:

```{r}
# SFSQL/WKT1_SIMPLE/WKT1/WKT1_GDAL/WKT1_ESRI/WKT2_2015/WKT2_2018/WKT2/DEFAULT
set_config_option("OSR_WKT_FORMAT", "WKT2")
```

## Warp

GDAL doc: https://gdal.org/programs/gdalwarp.html#memory-usage

The performance and caching topic above generally applies to processing with `gdalraster::warp()` (for reproject/resample/crop/mosaic). Increasing the warp memory may increase speed (e.g., `cl_arg` includes a value like `c("-wm", "800")`). Also, the warp memory specified by the `"-wm"` argument is shared among all threads. It is especially beneficial to increase this value when running `warp()` with `cl_arg` that includes `c("-wo", "NUM_THREADS=<value>")` greater than 1, which is equivalent to setting the `GDAL_NUM_THREADS` configuration option:

```{r}
# note this also affects other parts of GDAL (e.g., GeoTiff compression)
set_config_option("GDAL_NUM_THREADS", "8")
```

Increasing the I/O block cache size may also help. This can be done by setting the `GDAL_CACHEMAX` option as described above.

## GeoTIFF

GDAL doc: https://gdal.org/drivers/raster/gtiff.html#configuration-options

The behavior of the GTiff driver is highly configurable, including with respect to overview creation. For full discussion, see the link above and also the documentation for the [`gdaladdo`](https://gdal.org/programs/gdaladdo.html) command-line utility.

```{r}
# multi-threaded compression (default is compression in the main thread)
# specify the number of worker threads or `"ALL_CPUS"`
# worth it for slow compression algorithms such as DEFLATE or LZMA
# note this also affects other parts of GDAL (warping, gridding, ...)
set_config_option("GDAL_NUM_THREADS", "ALL_CPUS")

# compress overviews when building
# see method `buildOverviews()` in class `GDALRaster`
# applies to external overviews, and internal overviews if GDAL >= 3.6
# LZW is a good default (DEFLATE is also common and several others available)
set_config_option("COMPRESS_OVERVIEW", "LZW")
```

## AWS S3 buckets

GDAL doc: [/vsis3/](https://gdal.org/user/virtual_file_systems.html#vsis3-aws-s3-files) (AWS S3 file system handler)

Request signing can be diabled for public buckets that do not require an AWS account (`--no-sign-request` in AWS CLI), otherwise authentication credentials can be configured:

```{r}
# public bucket no AWS account required
set_config_option("AWS_NO_SIGN_REQUEST", "YES")

# or credentials required
set_config_option("AWS_ACCESS_KEY_ID", "<value>") # key ID
set_config_option("AWS_SECRET_ACCESS_KEY", "<value>") # secret access key
# used for validation of temporary credentials:
set_config_option("AWS_SESSION_TOKEN", "<value>") # session token
# requester pays:
set_config_option("AWS_REQUEST_PAYER", "<value>") # requester
```

## Google Cloud Storage

GDAL doc: [/vsigs/](https://gdal.org/user/virtual_file_systems.html#vsigs-google-cloud-storage-files) (Google Cloud Storage files)

## Microsoft Azure

GDAL doc: [/vsiaz/](https://gdal.org/user/virtual_file_systems.html#vsiaz-microsoft-azure-blob-files) (Microsoft Azure Blob files)
